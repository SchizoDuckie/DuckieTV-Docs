<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>DuckieTV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" type="text/css">
    <link rel="stylesheet" href="../css/bootstrap.css">
    <link rel="stylesheet" href="../css/cayman.css">
    <link rel="stylesheet" href="../css/prism.css">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">DuckieTV</h1>
      <h2 class="project-tagline">DuckieTV helps you manage your favorite TV Shows on a sweet calendar</h2><a href="https://npmjs.com/package/DuckieTV-Standalone" target="_blank" class="btn">View on npm</a>
    </section>
    <section data-spy="scroll" data-target=".scrollspy" class="main-content">
      <div class="row">
        <div class="col-md-3 col-xs-3 bs-docs-sidebar">
          <ul id="sidebar" class="nav nav-stacked fixed">
            <li><a href="../index.html">Main</a></li>
            <li><a href="../CRUD.entities.js.html">CRUD.entities.js</a></li>
            <li><a href="../app.authHttpBackend.js.html">app.authHttpBackend.js</a></li>
            <li><a href="../app.js.html">app.js</a></li>
            <li><a href="../app.requestinterceptors.js.html">app.requestinterceptors.js</a></li>
            <li><a href="../app.routes.js.html">app.routes.js</a></li>
            <li><a href="../app.standalone.systray.js.html">app.standalone.systray.js</a></li>
            <li><a href="../app.standalone.update.js.html">app.standalone.update.js</a></li>
            <li><a href="../app.standalone.windowdressing.js.html">app.standalone.windowdressing.js</a></li>
            <li><a href="../app.standalone.zoom.js.html">app.standalone.zoom.js</a></li>
            <li><a href="../app.translate.js.html">app.translate.js</a></li>
            <li><a href="../background.js.html">background.js</a></li>
            <li><a href="../classes/RemoteAPI.js.html">classes/RemoteAPI.js</a></li>
            <li><a href="../controllers/ActionBarCtrl.js.html">controllers/ActionBarCtrl.js</a></li>
            <li><a href="../controllers/WatchlistCtrl.js.html">controllers/WatchlistCtrl.js</a></li>
            <li><a href="../controllers/serieslist/LocalSeriesCtrl.js.html">controllers/serieslist/LocalSeriesCtrl.js</a></li>
            <li><a href="../controllers/serieslist/SeriesListCtrl.js.html">controllers/serieslist/SeriesListCtrl.js</a></li>
            <li><a href="../controllers/serieslist/TraktTVSearchCtrl.js.html">controllers/serieslist/TraktTVSearchCtrl.js</a></li>
            <li><a href="../controllers/serieslist/TraktTVTrendingCtrl.js.html">controllers/serieslist/TraktTVTrendingCtrl.js</a></li>
            <li><a href="../controllers/settings/BackupCtrl.js.html">controllers/settings/BackupCtrl.js</a></li>
            <li><a href="../controllers/settings/CalendarCtrl.js.html">controllers/settings/CalendarCtrl.js</a></li>
            <li><a href="../controllers/settings/DisplayCtrl.js.html">controllers/settings/DisplayCtrl.js</a></li>
            <li><a href="../controllers/settings/LanguageCtrl.js.html">controllers/settings/LanguageCtrl.js</a></li>
            <li><a href="../controllers/settings/SerieTorrentSettingsCtrl.js.html">controllers/settings/SerieTorrentSettingsCtrl.js</a></li>
            <li><a href="../controllers/settings/SettingsTorrentCtrl.js.html">controllers/settings/SettingsTorrentCtrl.js</a></li>
            <li><a href="../controllers/settings/SubtitlesCtrl.js.html">controllers/settings/SubtitlesCtrl.js</a></li>
            <li><a href="../controllers/settings/SyncCtrl.js.html">controllers/settings/SyncCtrl.js</a></li>
            <li><a href="../controllers/settings/TorrentClients/Deluge.js.html">controllers/settings/TorrentClients/Deluge.js</a></li>
            <li><a href="../controllers/settings/TorrentClients/Tixati.js.html">controllers/settings/TorrentClients/Tixati.js</a></li>
            <li><a href="../controllers/settings/TorrentClients/Transmission.js.html">controllers/settings/TorrentClients/Transmission.js</a></li>
            <li><a href="../controllers/settings/TorrentClients/Vuze.js.html">controllers/settings/TorrentClients/Vuze.js</a></li>
            <li><a href="../controllers/settings/TorrentClients/qBittorrent.js.html">controllers/settings/TorrentClients/qBittorrent.js</a></li>
            <li><a href="../controllers/settings/TorrentClients/qBittorrent32plus.js.html">controllers/settings/TorrentClients/qBittorrent32plus.js</a></li>
            <li><a href="../controllers/settings/TorrentClients/uTorrentWebUI.js.html">controllers/settings/TorrentClients/uTorrentWebUI.js</a></li>
            <li><a href="../controllers/settings/TraktTVCtrl.js.html">controllers/settings/TraktTVCtrl.js</a></li>
            <li><a href="../controllers/settings/customSearchEngineCtrl.js.html">controllers/settings/customSearchEngineCtrl.js</a></li>
            <li><a href="../controllers/sidepanel/AboutCtrl.js.html">controllers/sidepanel/AboutCtrl.js</a></li>
            <li><a href="../controllers/sidepanel/SettingsCtrl.js.html">controllers/sidepanel/SettingsCtrl.js</a></li>
            <li><a href="../controllers/sidepanel/SidepanelEpisodeCtrl.js.html">controllers/sidepanel/SidepanelEpisodeCtrl.js</a></li>
            <li><a href="../controllers/sidepanel/SidepanelSeasonCtrl.js.html">controllers/sidepanel/SidepanelSeasonCtrl.js</a></li>
            <li><a href="../controllers/sidepanel/SidepanelSeasonsCtrl.js.html">controllers/sidepanel/SidepanelSeasonsCtrl.js</a></li>
            <li><a href="../controllers/sidepanel/SidepanelSerieCtrl.js.html">controllers/sidepanel/SidepanelSerieCtrl.js</a></li>
            <li><a href="../controllers/sidepanel/SidepanelTraktSerieCtrl.js.html">controllers/sidepanel/SidepanelTraktSerieCtrl.js</a></li>
            <li><a href="../controllers/sidepanel/TorrentCtrl.js.html">controllers/sidepanel/TorrentCtrl.js</a></li>
            <li><a href="../controllers/sidepanel/TorrentDetailsCtrl.js.html">controllers/sidepanel/TorrentDetailsCtrl.js</a></li>
            <li><a href="../directives/backgroundRotator.js.html">directives/backgroundRotator.js</a></li>
            <li><a href="../directives/calendar.js.html">directives/calendar.js</a></li>
            <li><a href="../directives/calendarEvent.js.html">directives/calendarEvent.js</a></li>
            <li><a href="../directives/chromeTopSites.js.html">directives/chromeTopSites.js</a></li>
            <li><a href="../directives/datePicker.js.html">directives/datePicker.js</a></li>
            <li><a href="../directives/episodeDownloaded.js.html">directives/episodeDownloaded.js</a></li>
            <li><a href="../directives/episodeWatched.js.html">directives/episodeWatched.js</a></li>
            <li><a href="../directives/fastSearch.js.html">directives/fastSearch.js</a></li>
            <li><a href="../directives/focusWatch.js.html">directives/focusWatch.js</a></li>
            <li><a href="../directives/lazyBackground.js.html">directives/lazyBackground.js</a></li>
            <li><a href="../directives/loadingSpinner.js.html">directives/loadingSpinner.js</a></li>
            <li><a href="../directives/mouseWheelDown.js.html">directives/mouseWheelDown.js</a></li>
            <li><a href="../directives/mouseWheelUp.js.html">directives/mouseWheelUp.js</a></li>
            <li><a href="../directives/queryMonitor.js.html">directives/queryMonitor.js</a></li>
            <li><a href="../directives/serieDetails.js.html">directives/serieDetails.js</a></li>
            <li><a href="../directives/serieheader.js.html">directives/serieheader.js</a></li>
            <li><a href="../directives/seriesList.js.html">directives/seriesList.js</a></li>
            <li><a href="../directives/sidePanel.js.html">directives/sidePanel.js</a></li>
            <li><a href="../directives/stopEvent.js.html">directives/stopEvent.js</a></li>
            <li><a href="../directives/subtitleDialog.js.html">directives/subtitleDialog.js</a></li>
            <li><a href="../directives/targetBlank.js.html">directives/targetBlank.js</a></li>
            <li><a href="../directives/torrentDialog.js.html">directives/torrentDialog.js</a></li>
            <li><a href="../directives/torrentRemoteControl.js.html">directives/torrentRemoteControl.js</a></li>
            <li><a href="../services/AutoDownloadService.js.html">services/AutoDownloadService.js</a></li>
            <li><a href="../services/BaseHTTPApi.js.html">services/BaseHTTPApi.js</a></li>
            <li><a href="../services/CalendarEvents.js.html">services/CalendarEvents.js</a></li>
            <li><a href="../services/ChromeStorageSyncTarget.js.html">services/ChromeStorageSyncTarget.js</a></li>
            <li><a href="../services/DuckieTorrent.js.html">services/DuckieTorrent.js</a></li>
            <li><a href="../services/EpisodeWatchedMonitor.js.html">services/EpisodeWatchedMonitor.js</a></li>
            <li><a href="../services/FavoritesService.js.html">services/FavoritesService.js</a></li>
            <li><a href="../services/FileReader.js.html">services/FileReader.js</a></li>
            <li><a href="../services/FormlyLoaderService.js.html">services/FormlyLoaderService.js</a></li>
            <li><a href="../services/GoogleImages.js.html">services/GoogleImages.js</a></li>
            <li><a href="../services/IMDB.js.html">services/IMDB.js</a></li>
            <li><a href="../services/MigrationService.js.html">services/MigrationService.js</a></li>
            <li><a href="../services/Netflix.js.html">services/Netflix.js</a></li>
            <li><a href="../services/NotificationService.js.html">services/NotificationService.js</a></li>
            <li><a href="../services/OpenSubtitles.js.html">services/OpenSubtitles.js</a></li>
            <li><a href="../services/PowderPlayer.js.html">services/PowderPlayer.js</a></li>
            <li><a href="../services/SceneNameResolver.js.html">services/SceneNameResolver.js</a></li>
            <li><a href="../services/SceneXemResolver.js.html">services/SceneXemResolver.js</a></li>
            <li><a href="../services/SettingsService.js.html">services/SettingsService.js</a></li>
            <li><a href="../services/StorageSyncService.js.html">services/StorageSyncService.js</a></li>
            <li><a href="../services/SyncManager.js.html">services/SyncManager.js</a></li>
            <li><a href="../services/TorrentClients/BaseTorrentClient.js.html">services/TorrentClients/BaseTorrentClient.js</a></li>
            <li><a href="../services/TorrentClients/Deluge.js.html">services/TorrentClients/Deluge.js</a></li>
            <li><a href="../services/TorrentClients/Tixati.js.html">services/TorrentClients/Tixati.js</a></li>
            <li><a href="../services/TorrentClients/TorrentData.js.html">services/TorrentClients/TorrentData.js</a></li>
            <li><a href="../services/TorrentClients/Transmission.js.html">services/TorrentClients/Transmission.js</a></li>
            <li><a href="../services/TorrentClients/Vuze.js.html">services/TorrentClients/Vuze.js</a></li>
            <li><a href="../services/TorrentClients/qBittorrent.js.html">services/TorrentClients/qBittorrent.js</a></li>
            <li><a href="../services/TorrentClients/qBittorrent32plus.js.html">services/TorrentClients/qBittorrent32plus.js</a></li>
            <li><a href="../services/TorrentClients/uTorrent.js.html">services/TorrentClients/uTorrent.js</a></li>
            <li><a href="../services/TorrentClients/uTorrentWebUI.js.html">services/TorrentClients/uTorrentWebUI.js</a></li>
            <li><a href="../services/TorrentFreak.js.html">services/TorrentFreak.js</a></li>
            <li><a href="../services/TorrentHashListService.js.html">services/TorrentHashListService.js</a></li>
            <li><a href="../services/TorrentMonitor.js.html">services/TorrentMonitor.js</a></li>
            <li><a href="../services/TorrentSearchEngines/GenericTorrentSearchEngine.js.html">services/TorrentSearchEngines/GenericTorrentSearchEngine.js</a></li>
            <li><a href="../services/TorrentSearchEngines/Kickass.js.html">services/TorrentSearchEngines/Kickass.js</a></li>
            <li><a href="../services/TorrentSearchEngines/KickassMirrorResolver.js.html">services/TorrentSearchEngines/KickassMirrorResolver.js</a></li>
            <li><a href="../services/TorrentSearchEngines/Nyaa.js.html">services/TorrentSearchEngines/Nyaa.js</a></li>
            <li><a href="../services/TorrentSearchEngines/RarBG.js.html">services/TorrentSearchEngines/RarBG.js</a></li>
            <li><a href="../services/TorrentSearchEngines/ShowRSS.js.html">services/TorrentSearchEngines/ShowRSS.js</a></li>
            <li><a href="../services/TorrentSearchEngines/Strike.js.html">services/TorrentSearchEngines/Strike.js</a></li>
            <li><a href="../services/TorrentSearchEngines/ThePirateBay.js.html">services/TorrentSearchEngines/ThePirateBay.js</a></li>
            <li><a href="../services/TorrentSearchEngines/ThePirateBayMirrorResolver.js.html">services/TorrentSearchEngines/ThePirateBayMirrorResolver.js</a></li>
            <li><a href="../services/TorrentSearchEngines/TorrentSearchEngines.js.html">services/TorrentSearchEngines/TorrentSearchEngines.js</a></li>
            <li><a href="../services/TorrentSearchEngines/Torrentz.eu.js.html">services/TorrentSearchEngines/Torrentz.eu.js</a></li>
            <li><a href="../services/TraktTVStorageSyncTarget.js.html">services/TraktTVStorageSyncTarget.js</a></li>
            <li><a href="../services/TraktTVTrending.js.html">services/TraktTVTrending.js</a></li>
            <li><a href="../services/TraktTVUpdateService.js.html">services/TraktTVUpdateService.js</a></li>
            <li class="active"><a href="../services/TraktTVv2.js.html">services/TraktTVv2.js
                <ul class="nav nav-stacked">
                  <li><a href="#trakt"><i class="alert alert-info"></i><span>trakt</span></a>
                  </li>
                  <li><a href="#serie"><i class="alert alert-info"></i><span>serie</span></a>
                  </li>
                  <li><a href="#getUrl"><i class="alert alert-info"></i><span>getUrl</span></a>
                  </li>
                  <li><a href="#getParser"><i class="alert alert-info"></i><span>getParser</span></a>
                  </li>
                  <li><a href="#rethrow"><i class="alert alert-info"></i><span>rethrow</span></a>
                  </li>
                  <li><a href="#promiseRequest"><i class="alert alert-info"></i><span>promiseRequest</span></a>
                  </li>
                  <li><a href="#markEpisodeWatched"><i class="alert alert-info"></i><span>markEpisodeWatched</span></a>
                  </li>
                  <li><a href="#markEpisodeNotWatched"><i class="alert alert-info"></i><span>markEpisodeNotWatched</span></a>
                  </li>
                </ul></a></li>
            <li><a href="../services/UpgradeNotificationService.js.html">services/UpgradeNotificationService.js</a></li>
            <li><a href="../services/WatchlistCheckerService.js.html">services/WatchlistCheckerService.js</a></li>
            <li><a href="../services/WatchlistService.js.html">services/WatchlistService.js</a></li>
            <li><a href="../utility.js.html">utility.js</a></li>
          </ul>
        </div>
        <div class="col-md-9">
          <div class="description"><p>Trakt TV V2 API interfacing.<br />Throughout the app the API from Trakt.TV is used to fetch content about shows and optionally the user&#39;s data</p><p>For API docs: check here: <a href="http://docs.trakt.apiary.io/#">http://docs.trakt.apiary.io/#</a></p></div>
          <pre><code class="language-javascript">DuckieTV.factory('TraktTVv2', [&quot;SettingsService&quot;, &quot;$q&quot;, &quot;$http&quot;, &quot;toaster&quot;,
    function(SettingsService, $q, $http, toaster) {

        var activeSearchRequest = false,
            activeTrendingRequest = false,
            cachedTrending = null;

        var APIkey = '90b2bb1a8203e81a0272fb8717fa8b19ec635d8568632e41d1fcf872a2a2d9d0';
        var endpoint = 'https://api-v2launch.trakt.tv/';
        var pinUrl = 'https://trakt.tv/pin/948';
        /// shows / game - of - thrones / seasons ? extended = full, images

        var endpoints = {
            people: 'shows/%s/people',
            serie: 'shows/%s?extended=full,images',
            seasons: 'shows/%s/seasons?extended=full,images',
            episodes: 'shows/%s/seasons/%s/episodes?extended=full,images',
            search: 'search?type=show&amp;extended=full,images&amp;query=%s&amp;limit=50',
            trending: 'shows/trending?extended=full,images&amp;limit=500',
            tvdb_id: 'search?id_type=tvdb&amp;id=%s',
            login: 'auth/login',
            updated: 'shows/updates/%s?limit=10000',
            config: 'users/settings',
            token: 'oauth/token',
            watched: 'sync/watched/shows?extended=full,images&amp;limit=10000',
            episodeSeen: 'sync/history',
            episodeUnseen: 'sync/history/remove',
            userShows: 'sync/collection/shows?extended=full,images&amp;limit=10000',
            addCollection: 'sync/collection',
            removeCollection: 'sync/collection/remove'
        };

        var parsers = {</code></pre>
          <section id="trakt">
            <h1>trakt</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>trakt()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>When the series lists are fetched, put the poster / banner / fanart properties on the main<br />object instead of inside data.images. This makes sure that the API between the CRUD entity and the<br />incoming data is the same.</p></div>
          <pre><code class="language-javascript">trakt: function(show) {
    Object.keys(show.ids).map(function(key) {
        show[key + '_id'] = show.ids[key];
    });
    if ('images' in show) {
        if ('fanart' in show.images) {
            show.fanart = show.images.fanart.full;
        }
        if ('poster' in show.images) {
            show.poster = show.images.poster.thumb;
        }
        if ('banner' in show.images) {
            show.banner = 'thumb' in show.images.banner ? show.images.banner.thumb : show.images.banner.full;
        }
    }
    if ('title' in show) {
        show.name = show.title;
    }
    return show;
},
people: function(result) {
    return result.data;
},
seasons: function(result) {
    return result.data.map(function(season) {
        return parsers.trakt(season);
    });
},
search: function(result) {
    return result.data.map(function(show) {
        return parsers.trakt(show.show);
    });
},
trending: function(result) {
    return result.data.map(function(show) {
        return parsers.trakt(show.show);
    });
},
episodes: function(result) {
    var map = [],
        episodes = [];

    result.data.map(function(episode) {
        if (map.indexOf(episode.number) &gt; -1 || episode.number === 0) return;
        episodes.push(parsers.trakt(episode));
        map.push(episode.number);
    });
    return episodes;
},</code></pre>
          <section id="serie">
            <h1>serie</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>serie()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Trakt returns a list of search results here. We want only the first object that has a serie detail object in it.</p></div>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>trakt</td>
                <td></td>
                <td><p>result data</p></td>
              </tr>
              <tr>
                <td>return</td>
                <td></td>
                <td><p>serie parsed serie</p></td>
              </tr>
            </tbody>
          </table>
          <pre><code class="language-javascript">serie: function(result) {
    return parsers.trakt(result.data);
},
tvdb_id: function(result) {
    var results = result.data.filter(function(record) {
        return record.type == &quot;show&quot;;
    });
    if (results.length &gt; 0) {
        return parsers.trakt(results[0].show);
    } else {
        throw &quot;No results for search by tvdb_id&quot;;
    }
},
updated: function(result) {
    return result.data.map(function(show) {
        out = parsers.trakt(show.show);
        out.remote_updated = show.updated_at;
        return out;
    });
},
watched: function(result) {
    return result.data.map(function(show) {
        out = parsers.trakt(show.show);
        out.seasons = show.seasons;
        return out;
    });
},
userShows: function(result) {
    return result.data.map(function(show) {
        out = parsers.trakt(show.show);
        return out;
    });
}
        };

        // trakt api GET methods that require authorisation
        var authorized = [
'watched', 'userShows', 'config'
        ];</code></pre>
          <section id="getUrl">
            <h1>getUrl</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">function</div><span>&nbsp;</span><span>getUrl()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Get one of the urls from the endpoint and replace the parameters in it when provided.</p></div>
          <pre><code class="language-javascript">var getUrl = function(type, param, param2) {
    var out = endpoint + endpoints[type].replace('%s', encodeURIComponent(param));
    return (param2 !== undefined) ? out.replace('%s', encodeURIComponent(param2)) : out;
};</code></pre>
          <section id="getParser">
            <h1>getParser</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">function</div><span>&nbsp;</span><span>getParser()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>If a customized parser is available for the data, run it through that.</p></div>
          <pre><code class="language-javascript">var getParser = function(type) {
    return type in parsers ? parsers[type] : function(data) {
        return data.data;
    };
};</code></pre>
          <section id="rethrow">
            <h1>rethrow</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">function</div><span>&nbsp;</span><span>rethrow()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Generic error-catching and re-throwing</p></div>
          <pre><code class="language-javascript">var rethrow = function(err) {
    throw err;
};</code></pre>
          <section id="promiseRequest">
            <h1>promiseRequest</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">function</div><span>&nbsp;</span><span>promiseRequest()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Promise requests with batchmode toggle to auto-kill a previous request when running.<br />The activeRequest and batchMode toggles make sure that find-as-you-type can execute multiple<br />queries in rapid succession by aborting the previous one. Can be turned off at will by using enableBatchMode()</p></div>
          <pre><code class="language-javascript">var promiseRequest = function(type, param, param2, promise) {

    var url = getUrl(type, param, param2);
    var parser = getParser(type);
    var headers = {
        'trakt-api-key': APIkey,
        'trakt-api-version': 2,
        'accept': 'application/json'
    };
    if (authorized.indexOf(type) &gt; -1) {
        headers.Authorization = 'Bearer ' + localStorage.getItem('trakttv.token');
    }
    return $http.get(url, {
        timeout: promise ? promise : 120000,
        headers: headers,
        cache: false,
    }).then(function(result) {
        return parser(result);
    }, function(err) {
        // if err.code == 400 
        // token auth expired
        // show re-auth dialog
        // restart request and return original promise
        if (err.status !== 0) { // only if this is not a cancelled request, rethrow
            console.error(&quot;Trakt tv error!&quot;, err);
            throw &quot;Error &quot; + err.status + &quot;:&quot; + err.statusText;
        }
    });
};

var service = {
    serie: function(slug) {
        return promiseRequest('serie', slug).then(function(serie) {
            return service.people(serie.trakt_id).then(function(result) {
                serie.people = result;
            }, rethrow).then(function() {
                return service.seasons(serie.trakt_id).then(function(result) {
                    serie.seasons = result;
                }, rethrow).then(function() {
                    return $q.all(serie.seasons.map(function(season, index) {
                        return service.episodes(serie.trakt_id, season.number).then(function(episodes) {
                            serie.seasons[index].episodes = episodes;
                            return true;
                        }, rethrow);
                    }));
                }, rethrow).then(function() {
                    return serie;
                }, rethrow);
            });
        });
    },
    seasons: function(slug) {
        return promiseRequest('seasons', slug);
    },
    episodes: function(slug, seasonNumber) {
        return promiseRequest('episodes', slug, seasonNumber);
    },
    people: function(slug) {
        return promiseRequest('people', slug);
    },
    search: function(what) {
        service.cancelTrending();
        service.cancelSearch();
        activeSearchRequest = $q.defer();
        return promiseRequest('search', what, null, activeSearchRequest.promise).then(function(results) {
            activeSearchRequest = false;
            return results;
        });
    },
    cancelSearch: function() {
        if (activeSearchRequest &amp;&amp; activeSearchRequest.resolve) {
            activeSearchRequest.reject(&quot;search abort&quot;);
            activeSearchRequest = false;
        }
    },
    hasActiveSearchRequest: function() {
        return (activeSearchRequest &amp;&amp; activeSearchRequest.resolve);
    },
    trending: function(noCache) {
        if (undefined === noCache) {
            if (!localStorage.getItem('trakttv.trending.cache')) {
                return $http.get('trakt-trending-500.json').then(function(result) {
                    var output = result.data.filter(function(show) {
                        return typeof(show.show.ids.tvdb) !== &quot;undefined&quot;;
                    }).map(function(show) {
                        return parsers.trakt(show.show);
                    });
                    return output;
                });
            } else {
                return $q(function(resolve) {
                    resolve(JSON.parse(localStorage.getItem('trakttv.trending.cache')));
                });
            }
        }

        service.cancelTrending();
        service.cancelSearch();
        activeTrendingRequest = $q.defer();
        return promiseRequest('trending', null, null, activeTrendingRequest.promise).then(function(results) {
            activePromiseRequest = false;
            cachedTrending = results;
            return results;
        });
    },
    cancelTrending: function() {
        if (activeTrendingRequest &amp;&amp; activeTrendingRequest.resolve) {
            activeTrendingRequest.resolve();
            activeTrendingRequest = false;
        }
    },
    resolveTVDBID: function(id) {
        return promiseRequest('tvdb_id', id).then(function(result) {
            return result;
        }, function(error) {
            toaster.pop('eror', &quot;Error fetching from Trakt.TV&quot;, 'Could not find serie by TVDB_ID: ' + id + '&lt;br&gt;' + error.message, null);
            throw &quot;Could not resolve TVDB_ID from Trakt.TV &quot; + error.message;
        });
    },
    getPinUrl: function() {
        return pinUrl;
    },
    login: function(pin) {
        return $http.post(getUrl('token'), JSON.stringify({
            'code': pin,
            'client_id': '90b2bb1a8203e81a0272fb8717fa8b19ec635d8568632e41d1fcf872a2a2d9d0',
            'client_secret': 'f1c3e2df8f7a5e2705879fb33db655bc4aa96c0f33a674f3fc7749211ea46794',
            'redirect_uri': 'urn:ietf:wg:oauth:2.0:oob',
            'grant_type': 'authorization_code',
        }), {
            headers: {
                'trakt-api-key': APIkey,
                'trakt-api-version': 2,
                'Content-Type': 'application/json'
            }
        }).then(function(result) {
            localStorage.setItem('trakttv.token', result.data.access_token);
            localStorage.setItem('trakttv.refresh_token', result.data.refresh_token);
            return result.data.access_token;
        }, function(error) {
            throw error;
        });
    },
    updated: function(since) {
        return promiseRequest('updated', since);
    },
    // Returns all shows a user has watched.
    watched: function() {
        return promiseRequest('watched').then(function(result) {
            console.info(&quot;Fetched V2 API watched results: &quot;, result);
            return result;
        });
    },</code></pre>
          <section id="markEpisodeWatched">
            <h1>markEpisodeWatched</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>markEpisodeWatched()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Mark an episode as watched.<br />Can be passed either a CRUD entity or a plain series object and an episode. no longer true??<br /><a href="http://trakt.tv/api-docs/show-episode-seen">http://trakt.tv/api-docs/show-episode-seen</a></p></div>
          <pre><code class="language-javascript">markEpisodeWatched: function(serie, episode) {
    $http.post(getUrl('episodeSeen'), {
        episodes: [{
            'watched_at': new Date(episode.watchedAt).toISOString(),
            ids: {
                trakt: episode.TRAKT_ID
            }
        }]
    }, {
        headers: {
            'trakt-api-key': APIkey,
            'trakt-api-version': 2,
            'Authorization': 'Bearer ' + localStorage.getItem('trakttv.token'),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    }).then(function(result) {
        //console.debug(&quot;Episode watched:&quot;, serie, episode);
    });
},</code></pre>
          <section id="markEpisodeNotWatched">
            <h1>markEpisodeNotWatched</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>markEpisodeNotWatched()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Mark an episode as not watched.<br />Can be passed either a CRUD entity or a plain series object and an episode. no longer true??<br /><a href="http://trakt.tv/api-docs/show-episode-unseen">http://trakt.tv/api-docs/show-episode-unseen</a></p></div>
          <pre><code class="language-javascript">markEpisodeNotWatched: function(serie, episode) {
    var s = (serie instanceof CRUD.Entity) ? serie.get('TVDB_ID') : serie;
    var sn = episode.seasonnumber;
    var en = episode.episodenumber;

    $http.post(getUrl('episodeUnseen'), {
        movies: [],
        shows: [],
        episodes: [{
            ids: {
                trakt: episode.TRAKT_ID
            }
        }]
    }, {
        headers: {
            'trakt-api-key': APIkey,
            'trakt-api-version': 2,
            'Authorization': 'Bearer ' + localStorage.getItem('trakttv.token'),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    }).then(function(result) {
        //console.debug(&quot;Episode un-watched:&quot;, serie, episode);
    });
},
// Returns all shows in a users collection
userShows: function() {
    return promiseRequest('userShows').then(function(result) {
        console.info(&quot;Fetched V2 API User Shows: &quot;, result);

        return result;
    });
},
addToCollection: function(serieID) {
    $http.post(getUrl('addCollection'), {
        shows: [{
            ids: {
                tvdb: serieID
            }
        }]
    }, {
        headers: {
            'trakt-api-key': APIkey,
            'trakt-api-version': 2,
            'Authorization': 'Bearer ' + localStorage.getItem('trakttv.token'),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    }).then(function(result) {
        console.info(&quot;Show added to collection:&quot;, serieID);
    });
},
removeFromCollection: function(serieID) {
    $http.post(getUrl('removeCollection'), {
        shows: [{
            ids: {
                tvdb: serieID
            }
        }]
    }, {
        headers: {
            'trakt-api-key': APIkey,
            'trakt-api-version': 2,
            'Authorization': 'Bearer ' + localStorage.getItem('trakttv.token'),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    }).then(function(result) {
        console.info(&quot;Removed serie from collection&quot;, serieID);
    });
}
        };
        return service;
    }
])

.run(function($rootScope, SettingsService, TraktTVv2) {</code></pre>
          <div class="description"><p>Catch the event when an episode is marked as watched<br />and forward it to TraktTV if syncing enabled.</p></div>
          <pre><code class="language-javascript">$rootScope.$on('episode:marked:watched', function(evt, episode) {
    //console.log(&quot;Mark as watched and sync!&quot;);
    if (SettingsService.get('trakttv.sync')) {
        CRUD.FindOne('Serie', {
            ID_Serie: episode.get('ID_Serie')
        }).then(function(serie) {
            TraktTVv2.markEpisodeWatched(serie, episode);
        });
    }
});</code></pre>
          <div class="description"><p>Catch the event when an episode is marked as NOT watched<br />and forward it to TraktTV if syncing enabled.</p></div>
          <pre><code class="language-javascript">$rootScope.$on('episode:marked:notwatched', function(evt, episode) {
    if (SettingsService.get('trakttv.sync')) {
        CRUD.FindOne('Serie', {
            ID_Serie: episode.get('ID_Serie')
        }).then(function(serie) {
            TraktTVv2.markEpisodeNotWatched(serie, episode);
        });
    }
});
});</code></pre>
          <div class="footer site-footer">
            <div class="span site-footer-owner"><a href="https://github.com/mr-doc/mr-doc-theme-cayman">Cayman</a> is maintained by <a href="https://github.com/iwatakeshi">iwatakeshi</a>.</div>
            <div class="span site-footer-credits">This page was generated by <a href="https://github.com/mr-doc/mr-doc">Mr. Doc</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</div>
          </div>
        </div>
      </div>
    </section>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/affix.js"></script>
    <script src="../js/dropdown.js"></script>
    <script src="../js/scrollspy.js"></script>
    <script src="../js/prism.js"></script>
    <script src="../js/prism-bash.js"></script>
    <script>
      $(document).ready(function(){
        $('body').scrollspy({
          target: ".bs-docs-sidebar",
          offset: 40
        });
        $('#sidebar').affix({
          offset:{
            bottom:60,
            top: 60
          }
        }) 
      });
    </script>
  </body>
</html>